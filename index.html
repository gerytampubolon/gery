<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Antares Smart Garden Dashboard</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
  color: #333;
}

.page {
  display: none;
}

.page.active {
  display: block;
}

header {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 2em;
  text-align: center;
  margin-bottom: 2em;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

header h1 {
  color: white;
  font-size: 2.5em;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
  letter-spacing: 1px;
}

.subtitle {
  color: rgba(255, 255, 255, 0.9);
  font-size: 1em;
  margin-top: 0.5em;
}

.datetime {
  color: white;
  font-size: 1.2em;
  margin-top: 1em;
  font-weight: 600;
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
  letter-spacing: 0.5px;
}

.login-container {
  max-width: 500px;
  margin: 5em auto;
}

.login-card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 3em;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.login-card h2 {
  color: #667eea;
  margin-bottom: 1.5em;
  font-size: 1.8em;
  text-align: center;
}

.info-box {
  background: #e3f2fd;
  border-left: 4px solid #2196F3;
  padding: 1em;
  margin-top: 1em;
  border-radius: 5px;
  font-size: 0.9em;
  color: #1565C0;
}

main {
  max-width: 1400px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 1.5em;
}

.card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 2em;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
}

.card h2 {
  color: #667eea;
  margin-bottom: 1.5em;
  font-size: 1.5em;
  display: flex;
  align-items: center;
  gap: 10px;
}

.card h2::before {
  content: '‚óè';
  color: #764ba2;
  font-size: 0.6em;
}

.full-width {
  grid-column: 1 / -1;
}

label {
  display: block;
  margin-top: 1em;
  font-weight: 600;
  color: #555;
  font-size: 0.9em;
}

input, select {
  padding: 0.8em;
  margin-top: 0.5em;
  width: 100%;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1em;
  transition: all 0.3s ease;
  background: white;
}

input:focus, select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

button {
  padding: 0.8em 2em;
  margin-top: 1em;
  margin-right: 0.5em;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1em;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  width: 100%;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

button:active {
  transform: translateY(0);
}

.status-badge {
  display: inline-block;
  padding: 0.5em 1em;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.9em;
  margin-top: 1em;
  animation: pulse 2s infinite;
}

.status-connected {
  background: #4caf50;
  color: white;
}

.status-error {
  background: #f44336;
  color: white;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.data-display {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1em;
  margin-top: 1em;
}

.data-box {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  padding: 1.5em;
  border-radius: 15px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.data-box::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #667eea, #764ba2);
}

.data-box:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.data-box h3 {
  font-size: 0.9em;
  color: #555;
  margin-bottom: 0.5em;
  font-weight: 600;
}

.data-box p {
  font-size: 2em;
  font-weight: 700;
  color: #667eea;
  margin: 0;
}

.data-icon {
  font-size: 2em;
  margin-bottom: 0.3em;
}

#log {
  background: #1e1e1e;
  color: #00ff00;
  font-family: 'Courier New', monospace;
  height: 300px;
  overflow-y: auto;
  padding: 1em;
  border-radius: 10px;
  font-size: 0.9em;
  line-height: 1.6;
  box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
}

#log::-webkit-scrollbar {
  width: 8px;
}

#log::-webkit-scrollbar-track {
  background: #2a2a2a;
}

#log::-webkit-scrollbar-thumb {
  background: #00ff00;
  border-radius: 4px;
}

.btn-disconnect {
  background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
  box-shadow: 0 4px 15px rgba(238, 9, 121, 0.4);
  margin-top: 0;
}

.btn-disconnect:hover {
  box-shadow: 0 6px 20px rgba(238, 9, 121, 0.6);
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1em;
}

.top-bar h2 {
  margin: 0;
}

.top-bar button {
  width: auto;
  margin: 0;
  padding: 0.6em 1.5em;
  font-size: 0.9em;
}

@media (max-width: 768px) {
  main {
    grid-template-columns: 1fr;
  }
  
  header h1 {
    font-size: 1.8em;
  }
  
  .login-container {
    margin: 2em auto;
  }
  
  .top-bar {
    flex-direction: column;
    gap: 1em;
  }
  
  .top-bar button {
    width: 100%;
  }
}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="page active">
  <header>
    <h1>üå± SMART GARDEN DASHBOARD</h1>
    <p class="subtitle">Monitor & Control Your Garden System - Remote Access</p>
    <div id="datetimeLogin" class="datetime"></div>
  </header>
  
  <div class="login-container">
    <div class="login-card">
      <h2>üîê Configuration</h2>
      <label>Access Key:
        <input id="accessKey" type="text" placeholder="Enter your Antares Access Key" required>
      </label>
      <label>App Name:
        <input id="app" type="text" placeholder="Smart_Garden1" required>
      </label>
      <label>Device Name:
        <input id="device" type="text" placeholder="Smart_Garden" required>
      </label>
      <label>Polling Interval (seconds):
        <input id="pollInterval" type="number" value="5" min="1" required>
      </label>
      <button id="btnConnect">üîå Connect & Start Monitoring</button>
      
      <div class="info-box">
        ‚ÑπÔ∏è <strong>Remote Access Enabled!</strong><br>
        Dashboard ini sekarang bisa diakses dari internet manapun. Tidak perlu berada di jaringan yang sama dengan device.
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARD PAGE -->
<div id="dashboardPage" class="page">
  <header>
    <h1>üå± SMART GARDEN DASHBOARD</h1>
    <p class="subtitle">Monitor & Control Your Garden System - Remote Access</p>
    <div id="datetimeDashboard" class="datetime"></div>
  </header>

  <main>
    <section class="card full-width">
      <div class="top-bar">
        <div>
          <h2>üìä Monitoring Status</h2>
          <div id="modeLabel" class="status-badge status-connected">‚óè Connected</div>
        </div>
        <button class="btn-disconnect" id="btnDisconnect">‚ùå Disconnect</button>
      </div>
    </section>

    <section class="card full-width">
      <h2>üìä Sensor Data</h2>
      <div class="data-display">
        <div class="data-box">
          <div class="data-icon">üå°Ô∏è</div>
          <h3>Suhu</h3>
          <p id="temp">--</p>
        </div>
        <div class="data-box">
          <div class="data-icon">üíß</div>
          <h3>Kelembapan Udara</h3>
          <p id="hum">--</p>
        </div>
        <div class="data-box">
          <div class="data-icon">üåç</div>
          <h3>Kelembapan Tanah</h3>
          <p id="soil">--</p>
        </div>
        <div class="data-box">
          <div class="data-icon">‚ö°</div>
          <h3>Status Pompa</h3>
          <p id="pump">--</p>
        </div>
      </div>
    </section>

    <section class="card full-width">
      <h2>üìù System Logs</h2>
      <div id="log"></div>
    </section>
  </main>
</div>

<script>
const CONFIG = {ACCESS_KEY:'', APP:'', DEVICE:''};
let fetchInterval;

function log(msg){
  const logDiv = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  logDiv.innerHTML += `[${time}] ${msg}<br>`;
  logDiv.scrollTop = logDiv.scrollHeight;
}

async function fetchLatest() {
  // Menggunakan Antares API langsung tanpa proxy lokal
  const url = `https://gery.vercel.app/api/fetch?app=${CONFIG.APP}&device=${CONFIG.DEVICE}&key=${CONFIG.ACCESS_KEY}`;
  
  try {
    const res = await fetch(url, {
      method: 'GET',
      headers: {
        'X-M2M-Origin': CONFIG.ACCESS_KEY,
        'Content-Type': 'application/json;ty=4',
        'Accept': 'application/json'
      }
    });

    if (!res.ok) {
      log(`‚ùå HTTP Error: ${res.status} - ${res.statusText}`);
      updateStatusBadge(false);
      return;
    }

    const data = await res.json();

    // Validasi struktur data dari Antares
    if (!data['m2m:cin'] || !data['m2m:cin'].con) {
      log(`‚ö†Ô∏è Format data tidak sesuai`);
      return;
    }

    const con = data['m2m:cin'].con;
    log('‚úÖ Data diterima dari Antares');
    updateStatusBadge(true);

    parseAndDisplay(con);

  } catch (e) {
    log('‚ùå Fetch error: ' + e.message);
    updateStatusBadge(false);
  }
}

function updateStatusBadge(isConnected) {
  const modeLabel = document.getElementById('modeLabel');
  if (isConnected) {
    modeLabel.className = 'status-badge status-connected';
  } else {
    modeLabel.className = 'status-badge status-error';
  }
}

function parseAndDisplay(con) {
  try {
    const parsed = typeof con === 'string' ? JSON.parse(con) : con;
    
    const suhu = parsed.T ?? parsed.t ?? parsed.temp ?? parsed.Temperature;
    const kelembapan = parsed.H ?? parsed.h ?? parsed.hum ?? parsed.Humidity;
    const tanah = parsed.Soil ?? parsed.soil ?? parsed.soilMoisture;
    const pompa = parsed.Pompa ?? parsed.pompa ?? parsed.Pump ?? parsed.pump;
    
    document.getElementById('temp').innerText = suhu !== undefined ? suhu.toFixed(1) + '¬∞C' : '--';
    document.getElementById('hum').innerText = kelembapan !== undefined ? kelembapan.toFixed(1) + '%' : '--';
    document.getElementById('soil').innerText = tanah !== undefined ? tanah + '%' : '--';
    document.getElementById('pump').innerText = pompa !== undefined ? pompa : '--';
  } catch (err) {
    log('‚ùå Parsing error: ' + err.message);
  }
}

function startPolling(interval){
  clearInterval(fetchInterval);
  log('üîÑ Mengambil data pertama kali...');
  fetchLatest();
  fetchInterval = setInterval(fetchLatest, interval * 1000);
  
  const modeLabel = document.getElementById('modeLabel');
  modeLabel.className = 'status-badge status-connected';
  modeLabel.innerHTML = '‚óè Connected (polling every ' + interval + 's)';
}

function showPage(pageId) {
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
  });
  document.getElementById(pageId).classList.add('active');
}

window.addEventListener('DOMContentLoaded', () => {
  // Update date and time for both pages
  function updateDateTime() {
    const now = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    };
    const dateStr = now.toLocaleDateString('id-ID', options);
    document.getElementById('datetimeLogin').textContent = dateStr;
    document.getElementById('datetimeDashboard').textContent = dateStr;
  }
  
  updateDateTime();
  setInterval(updateDateTime, 1000);
  
  // Connect button
  document.getElementById('btnConnect').onclick = () => {
    CONFIG.APP = document.getElementById('app').value.trim();
    CONFIG.DEVICE = document.getElementById('device').value.trim();
    CONFIG.ACCESS_KEY = document.getElementById('accessKey').value.trim();
    const interval = Number(document.getElementById('pollInterval').value);
    
    if (!CONFIG.APP || !CONFIG.DEVICE || !CONFIG.ACCESS_KEY) {
      alert('‚ö†Ô∏è Please fill in all configuration fields');
      return;
    }
    
    log('üöÄ Starting monitoring system...');
    log('üåê Connecting to Antares Cloud Platform...');
    startPolling(interval);
    showPage('dashboardPage');
  };
  
  // Disconnect button
  document.getElementById('btnDisconnect').onclick = () => {
    clearInterval(fetchInterval);
    log('üîå Disconnected from monitoring system');
    showPage('loginPage');
  };
});
</script>
</body>
</html>